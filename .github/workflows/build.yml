name: ğŸš€ Build and Deploy Scubex

on:
  # Trigger on pushes to main branch
  push:
    branches: [ main, develop ]
  
  # Trigger on pull requests to main
  pull_request:
    branches: [ main ]
  
  # Allow manual triggering
  workflow_dispatch:

jobs:
  build-frontend:
    name: ğŸ¨ Build Frontend
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x, 22.x]
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
      
      - name: ğŸ—ï¸ Build Frontend
        run: npm run build
      
      - name: ğŸ“Š Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-node-${{ matrix.node-version }}
          path: dist/
          retention-days: 30

  build-backend:
    name: â˜• Build Backend
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        java-version: [21]
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'
          cache: maven
      
      - name: ğŸ”§ Make Maven Wrapper Executable
        run: chmod +x ./scubex-backend/mvnw
      
      - name: ğŸ§ª Run Backend Tests
        run: ./scubex-backend/mvnw test -f ./scubex-backend/pom.xml
      
      - name: ğŸ—ï¸ Build Backend
        run: ./scubex-backend/mvnw clean package -DskipTests -f ./scubex-backend/pom.xml
      
      - name: ğŸ“Š Upload Backend JAR
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar-java-${{ matrix.java-version }}
          path: scubex-backend/target/*.jar
          retention-days: 30

  integration-test:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: [build-frontend, build-backend]
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
      
      - name: â˜• Setup Java JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: ğŸ“¦ Install Frontend Dependencies
        run: npm ci
      
      - name: ğŸ—ï¸ Build Frontend
        run: npm run build
      
      - name: ğŸ”§ Make Maven Wrapper Executable
        run: chmod +x ./scubex-backend/mvnw
      
      - name: ğŸš€ Start Backend Server
        run: |
          ./scubex-backend/mvnw spring-boot:run -f ./scubex-backend/pom.xml &
          echo $! > backend.pid
          # Wait for backend to start
          sleep 30
        timeout-minutes: 5
      
      - name: ğŸŒ Preview Frontend
        run: |
          npm run preview &
          echo $! > frontend.pid
          # Wait for frontend to start
          sleep 10
        timeout-minutes: 2
      
      - name: ğŸ§ª Health Check
        run: |
          # Check if backend is running
          curl -f http://localhost:8080/actuator/health || echo "Backend health check failed"
          # Check if frontend is serving
          curl -f http://localhost:4173 || echo "Frontend health check failed"
      
      - name: ğŸ›‘ Cleanup Processes
        if: always()
        run: |
          if [ -f backend.pid ]; then kill $(cat backend.pid) || true; fi
          if [ -f frontend.pid ]; then kill $(cat frontend.pid) || true; fi

  build-status:
    name: âœ… Build Status
    runs-on: ubuntu-latest
    needs: [build-frontend, build-backend, integration-test]
    if: always()
    
    steps:
      - name: ğŸ“Š Check Build Results
        run: |
          echo "Frontend Build: ${{ needs.build-frontend.result }}"
          echo "Backend Build: ${{ needs.build-backend.result }}"
          echo "Integration Tests: ${{ needs.integration-test.result }}"
          
          if [[ "${{ needs.build-frontend.result }}" != "success" || "${{ needs.build-backend.result }}" != "success" ]]; then
            echo "âŒ Build failed!"
            exit 1
          else
            echo "âœ… All builds successful!"
          fi

  # Optional: Deploy to GitHub Pages (for frontend only)
  deploy-pages:
    name: ğŸŒ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build-frontend, build-backend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
    permissions:
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
      
      - name: ğŸ—ï¸ Build for Production
        run: npm run build
        env:
          # Add any environment variables needed for production build
          NODE_ENV: production
      
      - name: ğŸ“‹ Setup Pages
        uses: actions/configure-pages@v4
      
      - name: ğŸ“¤ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'
      
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4